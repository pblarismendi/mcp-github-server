name: Auto-approve PRs from repository owner

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  auto-approve:
    name: Auto-approve PRs from owner
    runs-on: ubuntu-latest
    # Permisos necesarios para comentar y aprobar PRs
    permissions:
      contents: read
      pull-requests: write
    # Solo ejecutar si el PR es del due√±o del repositorio
    if: github.event.pull_request.user.login == github.repository_owner
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Try auto-approve with PAT
        continue-on-error: true
        uses: actions/github-script@v7
        id: try_approve
        env:
          PAT_CONFIGURED: ${{ secrets.GH_PAT != '' }}
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const { owner, repo, number } = context.issue;
            const prAuthor = context.payload.pull_request.user.login;
            const repoOwner = context.repo.owner;
            
            // Verificar si el PAT est√° configurado
            if (process.env.PAT_CONFIGURED !== 'true') {
              console.log('‚ö†Ô∏è GH_PAT no est√° configurado, saltando auto-aprobaci√≥n');
              process.exit(0);
            }
            
            if (prAuthor === repoOwner) {
              console.log(`Auto-aprobando PR #${number} del due√±o del repositorio (${prAuthor}) usando PAT`);
              
              try {
                await github.rest.pulls.createReview({
                  owner,
                  repo,
                  pull_number: number,
                  event: 'APPROVE',
                  body: '‚úÖ **Auto-aprobado**: Este PR fue creado por el due√±o del repositorio y cumple con los requisitos de calidad.'
                });
                
                console.log(`‚úÖ PR #${number} auto-aprobado exitosamente`);
              } catch (error) {
                console.error(`‚ùå Error al aprobar PR: ${error.message}`);
                throw error;
              }
            }

      - name: Add comment (fallback if PAT failed or not configured)
        if: always() && (steps.try_approve.outcome != 'success' || steps.try_approve.outcome == 'skipped')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo, number } = context.issue;
            const prAuthor = context.payload.pull_request.user.login;
            const repoOwner = context.repo.owner;
            
            if (prAuthor === repoOwner) {
              // Verificar si ya fue aprobado
              const reviews = await github.rest.pulls.listReviews({
                owner,
                repo,
                pull_number: number
              });
              
              const isApproved = reviews.data.some(r => r.state === 'APPROVED');
              
              if (!isApproved) {
                console.log(`Agregando comentario al PR #${number} del due√±o del repositorio (${prAuthor})`);
                
                const commentBody = `‚úÖ **PR listo para mergear**: Este PR fue creado por el due√±o del repositorio y est√° listo para ser mergeado.\n\nüí° **Para auto-aprobaci√≥n autom√°tica**: Configura un Personal Access Token (PAT) con permisos de \`repo\` como secret \`GH_PAT\` en la configuraci√≥n del repositorio. Ver [SETUP_AUTO_APPROVE.md](.github/workflows/SETUP_AUTO_APPROVE.md) para m√°s detalles.`;
                
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: number,
                  body: commentBody
                });
                
                console.log(`‚úÖ Comentario agregado al PR #${number}`);
              } else {
                console.log(`‚úÖ PR #${number} ya fue aprobado`);
              }
            } else {
              console.log(`‚è≠Ô∏è  Saltando: El PR #${number} fue creado por ${prAuthor}, no por el due√±o (${repoOwner})`);
            }

